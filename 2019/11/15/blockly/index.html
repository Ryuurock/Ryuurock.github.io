<!DOCTYPE html>
<html lang="zh-cn">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="baidu-site-verification" content="code-Hn2FTkozwu" />
  <meta name="google-site-verification" content="VRegEMvasrnJoWUYvftfL9jaiIF1ovA-dZPb4juzyCA" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="keyword" content="Web前端|前端|javascript|css|html|html5">
  <link rel="icon" href="/favicon.ico">
  <!-- Place this tag in your head or just before your close body tag. -->
  <title>
    
    blockly初探 - longwanxiang的博客 | Ryuurock | Web前端实习生
    
  </title>
  <link rel="canonical" href="https://ryuurock.github.io/2019/11/15/blockly/">
  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link href="//cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Bootstrap Core CSS -->
  
<link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Custom CSS -->
  
<link rel="stylesheet" href="/css/beantech.min.css">

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="/css/highlight.css">

  
<link rel="stylesheet" href="/css/widget.css">

  
<link rel="stylesheet" href="/css/rocket.css">

  
<link rel="stylesheet" href="/css/signature.css">

  
<link rel="stylesheet" href="/css/toc.css">

  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_qt49r5gb9r8b0529.css">
<meta name="generator" content="Hexo 6.0.0"></head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="">
    <!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
  header.intro-header{
    
      background-image: url('/covers/post/IMG_2544.JPG')
      /*post*/
    
  }
  
</style>

<header class="intro-header" >
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
          <div class="post-heading">
            <div class="tags">
                
            </div>
            <h1>blockly初探</h1>
            <h2 class="subheading">图形化编程必备——blockly</h2>
            <span class="meta">
                Posted by Wanxiang Long(Ryuurock) on
                2019-11-15
            </span>
          </div>
        
        </div>
      </div>
    </div>
  </div>
  
</header>


    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Longwx Blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/">Home</a></li>
          <li><a href="/about/">About</a></li><li><a href="/archive/">Archives</a></li><li><a href="/tags/">Tags</a></li></ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function () {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


    <!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>Blockly由google开发，scratch基于blockly创建了scratch-blocks，blockly地址<a target="_blank" rel="noopener" href="https://developers.google.com/blockly/">https://developers.google.com/blockly/</a>，github源码地址<a target="_blank" rel="noopener" href="https://github.com/google/blockly">https://github.com/google/blockly</a></p>
<p>Blockly工作区域名词介绍：<br>
<img src="image2019-9-19_16-4-30.png" alt="image2019-9-19_16-4-30"><br>
<strong>技术介绍</strong>：<br>
blockly90%的视觉技术以svg为主，包括代码块、滚动条等。小部分使用html，如toolbox、代码块入参的输入框（数字、颜色等）。</p>
<p><strong>运行原理</strong>：<br>
blockly的代码块本身是无法运行的，想要运行代码块需要定义每种代码块对应生成的javascript代码，再使用eval来执行Generating and Running Javascript（需要科学上网）。当然这只是运行代码块的方式之一，比如scratch就没有依赖代码生成，通过blockly派发的事件，生成了AST。后续的文章中我们会展开讲scratch的运行原理。</p>
<p>接下来，我们一步一步来，看blockly葫芦里卖的什么药。</p>
<h1>Toolbox和Flyout的创建</h1>
<h2 id="一切从toolbox说起"><a class="anchorjs-link" href="#一切从toolbox说起"></a>一切从toolbox说起</h2>
<p>toolbox字段是在创建整个blockly时需要传入的一个参数，它是一个字符串，一个xml格式的字符串，它描述了代码块如何在flyout区布局，就像我们写html一样，当然它只能大致描述顺序、分类、主题等，最终布局由配置决定。下面是一个toolbox的示例。详细描述看这里–<a target="_blank" rel="noopener" href="https://developers.google.com/blockly/guides/configure/web/toolbox">toolbox</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span> <span class="attr">xmlns</span>=<span class="string">&quot;https://developers.google.com/blockly/xml&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toolbox-categories&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">category</span> <span class="attr">name</span>=<span class="string">&quot;Logic&quot;</span> <span class="attr">categorystyle</span>=<span class="string">&quot;logic_category&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_compare&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_operation&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_negate&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_boolean&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_null&quot;</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;logic_ternary&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">category</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">category</span> <span class="attr">name</span>=<span class="string">&quot;Loops&quot;</span> <span class="attr">categorystyle</span>=<span class="string">&quot;loop_category&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_repeat_ext&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;TIMES&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_repeat&quot;</span> <span class="attr">disabled</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_whileUntil&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_for&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;FROM&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;TO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;BY&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_forEach&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_flow_statements&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">category</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Toolbox的创建"><a class="anchorjs-link" href="#Toolbox的创建"></a>Toolbox的创建</h3>
<p>toolbox直白点说就是“分类栏”（<em>blockly可以直接在toolbox中放置代码块，但是由于一般情况代码块较多，我们默认以有分类栏为例</em>），它可以创建递归的树形菜单。blockly将传入的toolbox使用DOMParser解析为XMLElement对象，对DOM树进行递归查找，tagName为CATEGORY的标签解析为大分类，将SEP解析为代码块或分类之间的分割线，将BLOCK、SHADOW、LABEL和BUTTON等解析为当前分类下的元素（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/toolbox.js#L310">查看代码</a>），并将这些解析到的dom节点缓存到当前对应的分类的下。</p>
<p>我们之前说了，blockly部分UI是html元素编写的，这里的toolbox就是这样。所以为了“偷懒”，blockly直接使用了goog.ui.tree.TreeControl（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/toolbox.js#L594">查看代码</a>）这个库来创建toolbox，它来自closure-library，这是一个上古时期的库，这里不太建议去太深入研究它。</p>
<h3 id="触发点击事件，实时创建Blocks"><a class="anchorjs-link" href="#触发点击事件，实时创建Blocks"></a>触发点击事件，实时创建Blocks</h3>
<p>接下来就是点击toolbox，创建每个代码块并展示flyout的过程了。</p>
<h4 id="block标签的解析"><a class="anchorjs-link" href="#block标签的解析"></a>block标签的解析</h4>
<p>在研究Block的创建之前我们先对每个标签进行解释：</p>
<h5 id="block"><a class="anchorjs-link" href="#block"></a>block</h5>
<p>block从字面也可以理解到它的作用，他就是一个可拖动的最小单位——代码块</p>
<h5 id="value-statement（value和statement具有同样的效果）"><a class="anchorjs-link" href="#value-statement（value和statement具有同样的效果）"></a>value/statement（value和statement具有同样的效果）</h5>
<p>value应放置于block标签内，它是顺序无关的，通过标签上的“name”属性与该代码块的具体配置（后面会讲具体的块声明，声明描述了块的具体UI，颜色图标文字等等）对应上。</p>
<p>value标签更像是某个代码块的某个输入的默认值。怎么理解这个输入呢，相信看过前面scratch抽象语法树的同学会知道，这里就不再赘述了，点击这里直接传送到input解释。有了value还不行，如果value标签内是空的你可能会看到这样的效果：<br>
<img src="image2019-9-21_9-53-11.png" alt="image2019-9-21_9-53-11"><br>
如果你想要给它一个默认值就需要shadow标签了，shadow标签描述了一个绝对的默认值，它是一个不可被拖动的块。</p>
<p>当我们给上面代码块每个value都声明了一个shadow标签，类似下面这样的xml代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_for&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;FROM&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;TO&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;BY&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;DO&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;IF0&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;lists_isEmpty&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>于是我们得到下面的结果：<br>
<img src="image2019-9-21_10-29-44.png" alt="image2019-9-21_10-29-44"><br>
第一个输入变量它是一个规定好的枚举类型几乎不可变我们先不管，后面三个输入在我们声明了shadow和filed后产生了一个默认值，这里需要说明下field的name属性，它定义了这个输入的类型，除了NUM之外还有其他内置的field类型（<a target="_blank" rel="noopener" href="https://developers.google.com/blockly/guides/create-custom-blocks/fields/built-in-fields/overview">这里有其他内置类型</a>）。接下来你看到连do里面也能有一个默认的块，那是不是可以递归下去写一个超大的代码块呢，答案是肯定的，我们来看看定义足够多的代码块将出现什么样的反应：<br>
<img src="image2019-9-21_10-46-1.png" alt="image2019-9-21_10-46-1"><br>
来看看代码长啥样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_for&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;FROM&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;TO&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;BY&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;math_number&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;NUM&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;DO&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;IF0&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;lists_isEmpty&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">next</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;IF0&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;lists_isEmpty&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;DO0&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;IF0&quot;</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;lists_isEmpty&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">next</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">block</span> <span class="attr">type</span>=<span class="string">&quot;controls_if&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">value</span> <span class="attr">name</span>=<span class="string">&quot;IF0&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">shadow</span> <span class="attr">type</span>=<span class="string">&quot;lists_isEmpty&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">shadow</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">next</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">next</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>神奇的next标签用来描述当前块的下一个连接块，这样我们就可以无限创造下去，是不是现在觉得，blockly创造了一个xml解析器，把xml解析为了代码块，就像html解析为了网页。</p>
<p>解析细节我相信你也不想错过，<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/xml.js#L597">查看源码</a></p>
<h4 id="块的声明"><a class="anchorjs-link" href="#块的声明"></a>块的声明</h4>
<p><a target="_blank" rel="noopener" href="https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks#block_inputs">官方文档</a><br>
看完blockly自定义解析器，我相信你还有很多疑问，比如block和shadow中的type如何定义的，value中的name又是如何找到的，下面我们一起来康康一个块是如何被定义的。</p>
<p>官方提供了两种声明块的方式，一个是通过js对象（官方称为json定义），另一个是通过jsapi定义。</p>
<h5 id="通过json定义"><a class="anchorjs-link" href="#通过json定义"></a>通过json定义</h5>
<p>我们先来看看下面这样一个代码块的json声明是什么样的:<br>
<img src="image2019-9-23_10-23-47.png" alt="image2019-9-23_10-23-47"><br>
下面是json声明，如果你对blockly的字段非常清楚或对它的工作方式非常了解可以跳过这一节。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;controls_repeat&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message0&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_TITLE&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;args0&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;field_number&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;TIMES&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">&quot;min&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;precision&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;message1&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_INPUT_DO&#125; %1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;args1&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;input_statement&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;DO&quot;</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;previousStatement&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;nextStatement&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;style&quot;</span>: <span class="string">&quot;loop_blocks&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tooltip&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_TOOLTIP&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;helpUrl&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_HELPURL&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>type：定义了代码块的id，把它理解为id更加合适，它是全局唯一的。定义xml时，block标签的type就是通过它找到配置的；</li>
<li>message：message被定义为一组输入，第零组为message0，第一组为message1……等，需要注意的是，必须是连续的。message包含了展示在代码块上的文本和该组内的输入，比如下拉框，默认值，代码块输入等，比如：，它就包含了一个“not”文本和一个代码块输入，message可以是“not %1”。上面代码中%{BKY_XXXX}和%1这样的声明是blockly的模版语法，前者是描述代码块内的描述文本的占位符通过Blockly.Msg能够找到所有的声明（scratch似乎没有使用这一套Blockly.Msg，里面没有内容），使用占位符很明显是为了国际化设计的。后者%数字是对应的message字段的下标对应的args数组的下标，巧了，它是又是从1开始的（真是看不懂这样的魔鬼设计）。；</li>
<li>args：args的定义规则和message是类似的，message中的 %数字需要找到args中对应的对象，args中的对象是对该输入的详细描述；</li>
</ul>
<p><em><strong>关于通过json定义的字段的解释，还是建议看官网的描述会更加详细（<a target="_blank" rel="noopener" href="https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks">define-blocks</a>）。</strong></em></p>
<h5 id="通过jsapi定义"><a class="anchorjs-link" href="#通过jsapi定义"></a>通过jsapi定义</h5>
<p>请参考官网文档<a target="_blank" rel="noopener" href="https://developers.google.com/blockly/guides/create-custom-blocks/define-blocks">define-blocks</a>。</p>
<h4 id="创建Blocks"><a class="anchorjs-link" href="#创建Blocks"></a>创建Blocks</h4>
<p>看到这里你可能已经耐不住性子了：怎么还没开始创建块！别急，我们这就开始。</p>
<h5 id="拿到对应分类的blocks数组"><a class="anchorjs-link" href="#拿到对应分类的blocks数组"></a>拿到对应分类的blocks数组</h5>
<p>我们之前讲到，在解析xml时只会解析到category，其他的类型比如block都会直接以dom的形式缓存到对应分类对象的数组里。那么在接下来的在点击分类栏的时候，会拿到对应分类的blocks数组</p>
<h5 id="解析json"><a class="anchorjs-link" href="#解析json"></a>解析json</h5>
<p>这一步只有通过json配置的代码块才有。通过json配置的代码块首先会调用 jsonInit 方法，然后从[message]和[args]字段开始解析，举个例子：</p>
<p>还是以repeat代码块为例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;controls_repeat_ext&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message0&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_TITLE&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;args0&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;input_value&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;TIMES&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;check&quot;</span>: <span class="string">&quot;Number&quot;</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;message1&quot;</span>: <span class="string">&quot; %&#123;BKY_CONTROLS_REPEAT_INPUT_DO&#125; %1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;args1&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;input_statement&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;DO&quot;</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">&quot;previousStatement&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;nextStatement&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;style&quot;</span>: <span class="string">&quot;loop_blocks&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tooltip&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_TOOLTIP&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;helpUrl&quot;</span>: <span class="string">&quot;%&#123;BKY_CONTROLS_REPEAT_HELPURL&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>%{BKY_CONTROLS_REPEAT_TITLE} 被解析为 repeat %1 times，然后再被拆解成这样一个数组：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;repeat &#x27;</span>, <span class="number">1</span>, <span class="string">&#x27; times&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>如果是数字，会从args0中找到第0（1 - 1）项，替换，再将字符串trim，最后得到</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">&#x27;repeat&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;input_value&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;TIMES&quot;</span>,</span><br><span class="line">    <span class="string">&quot;check&quot;</span>: <span class="string">&quot;Number&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;times&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这里有一个特殊逻——当数组最后一个对象为字符串或者最后一项的type为fields_开头，会自动在数组末端添加一个对象{ type: ‘input_dummy’ }，官方描述为“虚拟输入，类似换行符的效果”。</p>
<p><em>注：虚拟输入理解为换行没毛病，但是我觉得理解为“截断”会更加贴切。为什么这么说呢，当某个代码块被作为默认输入给另外一个代码块时（参考前面的递归解析xml），这里是没有换行的，而是这个代码块本身结束了，截断了，因为他就是一个表达式，没有后续的输入了。</em><br>
于是上面的代码就变成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">&#x27;repeat&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;input_value&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;TIMES&quot;</span>,</span><br><span class="line">    <span class="string">&quot;check&quot;</span>: <span class="string">&quot;Number&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;times&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;input_dummy&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>于是接下来又是一个遍历的过程：</p>
<p><strong>将对象类型前的所有字符串作为field添加到该对象中</strong>，如：</p>
<p>“repeat”给了name为TIMES的input_value，“times”给了input_dummy。当然中途还有对args内的其他对象做处理，如：check、align等等，前者是检查输入的类型，后者是布局用的。</p>
<p>这里还有一个不得不提的是，有些块是有输出的，比如一个像<img src="image2019-9-24_9-54-51.png" style="display: inline;margin: 0;" />这样的代码块，那它的输出应被声明为Number。</p>
<p>json的解析我们暂时就到这里，感兴趣的可以阅读源码（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/block.js#L1406">查看源码</a>）。</p>
<h5 id="绘制block"><a class="anchorjs-link" href="#绘制block"></a>绘制block</h5>
<p>接下来就是绘制block了，blockly将block的绘制分成了两步：</p>
<ul>
<li>创建整个块的svg结构。如：代码块形状的path标签，代码块的阴影，代码块的高光（是的，还有高光。scratch毅然抛弃这俩玩意儿，做的扁平化风格代码块），fields，如果有注释会添加注释的按钮，有设置还会添加设置按钮的扩展，类似这样 <img src="image2019-9-25_18-1-30.png" style="height: 30px;display: inline;margin: 0;" />。</li>
<li>然后是正式的开始绘制，绘制都是以path标签为基础，对它的d属性进行填充，好奇svg的path是如何使用的同学可以看<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c819ae16d29b">这里</a>；<br>
正式通过块产生path数据之前，会有一个计算的过程（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/block_render_svg.js#L414">查看源码</a>），源码注释解释为：计算每一行中字段产生的高度和宽度，这个过程同时也会计算出每个文本在代码块中的位置。</li>
</ul>
<p>绘制过程像是一个线段拼接的过程，blockly主要分成了四个大步骤来绘制一个代码块，上、又，下、左，我们来看看每个阶段绘制完成后是什么样的：<br>
<img src="image2019-9-26_17-35-18.png" alt="image2019-9-26_17-35-18"><br>
上：<br>
上面部分的绘制主要是看这个代码块是否可以有上一个声明，除了表达式和事件类型的代码块都可以有上个声明；</p>
<p>右：<br>
右侧部分绘制是最复杂的，首先要计算出这行（比如json解析中提到的message0）上所有的输入（input，如果代码中有默认的field值，还会去把field的宽度算上，比如你的field是number类型，并且值比较大的话就会占据较宽的位置）加起来的宽度和高度，以使代码块继续往右侧延伸。然后是遍历这个块所有的input以计算出右侧的线条，拿上面的代码块举例，<img src="image2019-9-26_17-50-13.png" style="height: 50px;display: inline;margin: 0;" />块的红框部分为一行，结尾没有扩展输入在计算完宽度后画笔直接往下走，绘制成这个样子：<img src="image2019-9-26_17-53-49.png" style="height: 50px;display: inline;margin: 0;" />，继续走，因为该块有input_statement，所以它继续绘制，于是你看到了上图中“右”那个阶段的状态。</p>
<p>下：<br>
下部的绘制也是相对简单的，逻辑则是判断该类型的块是否可以有nextStatement，如果有就会有一个小凸起。</p>
<p>左：<br>
左侧部分相对来说也比较简单，如果该块被声明为一个有output的块，那左侧会有一个可连接的标识，像这样：<img src="image2019-9-27_10-22-43.png" style="height: 25px;display: inline;margin: 0;" />。</p>
<p>不得不提的是，代码块的风格大部分由path标签决定的，里面的一些共通的地方（比如一些凸起和凹陷）都被声明成了常量，修改常量就能够达到修改整体风格的目的，比如我们修改prevStatement和nextStatement的那个凹陷和凸起对应的常量后，会得到一个类似scratch风格的代码块：<br>
<img src="image2019-9-27_10-40-16.png" alt="image2019-9-27_10-40-16"></p>
<h1>Flyout拖动创建代码块</h1>
<p>拖动创建代码块的过程实际上是一个非常简单的过程，在上一章中我们了解了如何创建一个block，生成了想要的svg结构，在拖动的时候就是把已有的svg结构（包括了path标签的d属性）复制放置到一个新的拖拽容器中，同时会把svg结构（只保留了结构，因没有实际的绘制，会在拖拽释放时再去绘制）放到工作区中隐藏起来，然后根据鼠标的移动从而去改变这个容器的位置实现了拖拽的效果。</p>
<p>那在拖拽着移动鼠标的过程会一直侦测沿途中是否有可以连接/包裹的代码块，一旦符合连接条件，即可对目标位置进行高亮处理，这也是接下来一章要给大家分享的内容。</p>
<h1>代码块的连接与移动</h1>
<p>刚刚我们简单说了下拖拽时创建block，其实在已在workspace中创建的block的拖动和在flyout中的拖动是一样的。当我们把代码块拖动到邻近的代码块时，如果类型匹配，就会出现一个预览效果如下图灰色的部分：<br>
<img style="display: inline" src="image2019-10-10_14-7-0.png" /><img style="display: inline" src="image2019-10-10_14-12-29.png" /><img style="display: inline" src="image2019-10-10_14-12-48.png" /><img style="display: inline" src="image2019-10-10_14-13-9.png" /><br>
你会发现blockly的拖动是如此的灵活，那它是如何实现的呢？</p>
<h2 id="connection"><a class="anchorjs-link" href="#connection"></a>connection</h2>
<p>在讲解拖拽之前，首先要了解blockly中的connection概念(<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/rendered_connection.js">https://github.com/google/blockly/blob/master/core/rendered_connection.js</a>)，它用于描述块与块之间的连接，是对blocks之间关系的一种抽象描述。它提供一些方法来处理连接逻辑，每个块的连接的接口（如previousConnection属性）都是这个类的实例。如果一定要打一个比喻的话，我觉得它和js的原型链有点像，但是原型链是1对1的关系，而connection是多对多的关系，因为它们都有多个口子供你建立和其他块的关系。所以你可以根据connection的描述来还原代码块之间的关系，那么代码块之间若要关联起来那必将涉及到connection。我们来看下面这组块的connection关系：<br>
<img src="image2019-10-10_14-42-43.png" alt="image2019-10-10_14-42-43"><br>
上面两个代码块都有previousConnection和nextConnection，现在放置的状态应为：蓝色代码块的nextConnection指向了绿色代码块的previousConnection，而绿色则相反，previousConnection指向了蓝色的nextConnection，当然实际代码肯定不是简单赋值就完成了，它还有一些复杂的判断逻辑，感兴趣的话点 <a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/connection.js#L137">这里</a>。</p>
<h2 id="开始拖动"><a class="anchorjs-link" href="#开始拖动"></a>开始拖动</h2>
<p>在摁住代码块（也可能是一组）开始拖动前，blockly会做一件准备工作，就是收集拖动的代码块的顶部块的所有能够被连接的地方，如：outputConnection、previousConnection、nextConnection和所有的input(在第一节的解析json处有解释)，这里blockly考虑到拖动一组代码块的时候，能够让最下面的代码块的nextConnection也能生效，所以还收集了底部块的nextConnection（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/insertion_marker_manager.js#L301">查看源码</a>）。如果你没有看懂我的描述可以看下图示意：<br>
<img src="image2019-10-10_14-57-43.png" alt="image2019-10-10_14-57-43"><br>
收集好connections那么下一步就是遍历这些connections，为它们寻找归宿。注意，下面的行为都是在鼠标拖住块不停的移动中的。</p>
<h2 id="寻找最近的可连接的目标"><a class="anchorjs-link" href="#寻找最近的可连接的目标"></a>寻找最近的可连接的目标</h2>
<p>在哪里寻找呢，在connectionDB中寻找，connectionDB（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/connection_db.js#L293">查看源码</a>）将整个workspace的connection分成了四类outputConnection、previousConnection、nextConnection和inputConnection，如果你当前是一个previousConnection，那肯定要寻找相反的类型nextConnection，outputConnection同理。</p>
<p><em><strong>半径常量（radius）——这里要提一嘴的是在寻找过程中一直有一个叫半径的东西，一句话解释就是【触发判断两个块是否真的可以connect的阈值】</strong></em></p>
<p>如果我们按照常规的思路去寻找最近的候选目标，那可能就是遍历对应的相反类型的x和y轴，在一定范围内就满足条件。但是随着代码块越来越多，计算会越来越多。blockly通过二分查找法找到当前connection在目标connection数组（这些connection都是按y轴升序排列，所以可以使用二分查找算法）中的位置（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/connection_db.js#L253">查看源码</a>）（注：blockly只在y轴上查找，应该是考虑到计算量和实现的问题）。</p>
<p>可能这里你看不太懂，举个栗子，有一个数组[10, 20, 30]，里面的数字代表connection的y坐标，然后这里有一个connection它的y坐标是15，那它的这个位置应该是1。</p>
<p>有了这个位置索引，能够极大的减少查找的范围，再通过刚才提到<strong>半径常量</strong>的限制，那么blockly就只会在半径常量规定的这个小范围的y轴范围内来回查找（经过我的尝试，确实只满足y轴就会触发复杂的connect check，但是这相对全盘遍历减少很多工作了）。</p>
<p>若在这个阶段匹配到了一个合适的connection（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/rendered_connection.js#L318">查看源码</a>），将会展示展示预览状态，移开将会删除预览，鼠标一旦在预览阶段释放，blockly则认为用户确认了这个连接，将为调用connect方法进行真正的连接（<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/insertion_marker_manager.js#L202">查看源码</a>，和<a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/connection.js#L137">实际连接的地方</a>），此时也会触发块的render函数重新计算整个快的布局。至此，整个blockly的块的连接大致就是这样的流程。</p>
<h1>扩展——增加候选connection个数</h1>
<p>上面我们提到，在开始拖动时会收集顶部代码块所有能被连接的地方，还会收集底部的nextConnection，那我们可不可以再增加一点呢，比如把底部的所有能被连接的地方都拿到，我们先看看改动前的效果：<br>
<img src="Oct-11-2019-14-28-00.gif" alt="Oct-11-2019 14-28-00"><br>
我们再看看改动源码进行扩展后的效果：<br>
<img src="Oct-11-2019-14-31-34.gif" alt="Oct-11-2019 14-28-00"><br>
你会发现被拖动的代码块组能够被触发connect预览的地方更多了。</p>
<p>改动很简单，因为我们读懂的它的代码，只需要修改 <a target="_blank" rel="noopener" href="https://github.com/google/blockly/blob/master/core/insertion_marker_manager.js#L306">收集connection的地方</a>，将：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">available.push(lastOnStack);</span><br><span class="line"><span class="comment">// 修改为</span></span><br><span class="line">available.push(...lastOnStack.getSourceBlock().getConnections_(<span class="literal">false</span>));</span><br></pre></td></tr></table></figure>
<p>我们在这里把最后一个代码块的所有connection都收集，甚至，你可以把拖动的块组里的所有块，及其子块的connection都收集到。</p>
<h1>生成可执行的代码</h1>
<p>代码块最终肯定是要运行看效果的，单纯的代码块肯定是无法运行的，blockly采用了block to scripts的方式使代码块运行起来。</p>
<p>什么是block to scripts呢，blockly的最小单位是block，就是我们可见的块，包括了不可拖动的shadow块，每个块需要定义对应生成脚本的函数。</p>
<p>举个blockly已有的JavaScript脚本生成的例子，先看代码块长啥样：<br>
<img src="image2019-10-12_11-43-33.png" alt="image2019-10-12_11-43-33"><br>
上述代码块生成的代码长这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> count = <span class="number">0</span>; count &lt; <span class="number">99</span>; count++) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码生成需要三步：</p>
<ol>
<li>获取输入次数；</li>
<li>获取input_statement对应的代码；</li>
<li>拼接脚本并返回。</li>
</ol>
<p>下面是伪代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Blockly.JavaScript[<span class="string">&#x27;controls_repeat_ext&#x27;</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">block</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> repeats = block.getFieldValue(<span class="string">&#x27;TIMES&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> branch = Blockly.JavaScript.statementToCode(block, <span class="string">&#x27;DO&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="string">`for (var count = 0; count &lt; <span class="subst">$&#123;repeats&#125;</span>; count++) &#123; <span class="subst">$&#123;branch&#125;</span> &#125;`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整套blockly的代码几乎都是这样，每个代码块对应一个脚本的生成逻辑，在生成逻辑内拿到用户的输入，再拼接脚本返回。</p>
<p>关于脚本的生成，我们简单了解到这里，scratch没有使用这一套东西，相较于blockly的原生方案，scratch选择了自己去维护一个runtime——scratch-vm，通过blockly提供的事件生成blocks的抽象描述——AST，使用VM的概念去将执行代码块。</p>


                <hr>
                <!-- Pager -->
                <ul class="pager clearfix">
                    
                    <li class="previous">
                        <a href="/2021/03/14/scratch/" data-toggle="tooltip" data-placement="top"
                            title="Scratch 漫谈">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/02/20/react-hoc-reverse-extend/" data-toggle="tooltip" data-placement="top"
                            title="React高阶组件之反向继承">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                

                <!-- UY BEGIN -->
                <br>
                <div id="uyan_frame"></div>
                <!--<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2138668"></script>-->
                <!-- UY END -->
                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>

            <!-- Tabe of Content -->
            <!-- Table of Contents -->


<aside id="sidebar">
  <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
    <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Toolbox和Flyout的创建</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%80%E5%88%87%E4%BB%8Etoolbox%E8%AF%B4%E8%B5%B7"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">一切从toolbox说起</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Toolbox%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">Toolbox的创建</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A7%A6%E5%8F%91%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%AE%9E%E6%97%B6%E5%88%9B%E5%BB%BABlocks"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">触发点击事件，实时创建Blocks</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#block%E6%A0%87%E7%AD%BE%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-nav-number">1.1.2.1.</span> <span class="toc-nav-text">block标签的解析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#block"><span class="toc-nav-number">1.1.2.1.1.</span> <span class="toc-nav-text">block</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#value-statement%EF%BC%88value%E5%92%8Cstatement%E5%85%B7%E6%9C%89%E5%90%8C%E6%A0%B7%E7%9A%84%E6%95%88%E6%9E%9C%EF%BC%89"><span class="toc-nav-number">1.1.2.1.2.</span> <span class="toc-nav-text">value&#x2F;statement（value和statement具有同样的效果）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%9D%97%E7%9A%84%E5%A3%B0%E6%98%8E"><span class="toc-nav-number">1.1.2.2.</span> <span class="toc-nav-text">块的声明</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%80%9A%E8%BF%87json%E5%AE%9A%E4%B9%89"><span class="toc-nav-number">1.1.2.2.1.</span> <span class="toc-nav-text">通过json定义</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%80%9A%E8%BF%87jsapi%E5%AE%9A%E4%B9%89"><span class="toc-nav-number">1.1.2.2.2.</span> <span class="toc-nav-text">通过jsapi定义</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BABlocks"><span class="toc-nav-number">1.1.2.3.</span> <span class="toc-nav-text">创建Blocks</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%8B%BF%E5%88%B0%E5%AF%B9%E5%BA%94%E5%88%86%E7%B1%BB%E7%9A%84blocks%E6%95%B0%E7%BB%84"><span class="toc-nav-number">1.1.2.3.1.</span> <span class="toc-nav-text">拿到对应分类的blocks数组</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%A7%A3%E6%9E%90json"><span class="toc-nav-number">1.1.2.3.2.</span> <span class="toc-nav-text">解析json</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E7%BB%98%E5%88%B6block"><span class="toc-nav-number">1.1.2.3.3.</span> <span class="toc-nav-text">绘制block</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Flyout拖动创建代码块</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">代码块的连接与移动</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#connection"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">connection</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BC%80%E5%A7%8B%E6%8B%96%E5%8A%A8"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">开始拖动</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AF%BB%E6%89%BE%E6%9C%80%E8%BF%91%E7%9A%84%E5%8F%AF%E8%BF%9E%E6%8E%A5%E7%9A%84%E7%9B%AE%E6%A0%87"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">寻找最近的可连接的目标</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">扩展——增加候选connection个数</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">生成可执行的代码</span></a></li></ol>
    
  </div>
</aside>




            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async (u, c) {
        var d = document,
            t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) {
            o.addEventListener('load', function (e) {
                c(null, e);
            }, false);
        }
        s.parentNode.insertBefore(o, s);
    }
</script>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
          
          

          
          <li>
            <a target="_blank" href="http://weibo.com/2539035205">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

          

          
          <li>
            <a target="_blank" href="https://github.com/Ryuurock">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

          

          
          <li>
            <a href="mailto:lwx_1993@outlook.com">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

        </ul>
        <p class="copyright text-muted">
          Wanxiang Long(Ryuurock) &copy; 1993-2022
          <br>
          <span id="busuanzi_container_site_uv">小站访客数<span id="busuanzi_value_site_uv"></span>人次</span>
          |
          <span id="busuanzi_container_site_pv">小站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
        </p>
      </div>
    </div>
  </div>
</footer>


<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/lx-blog.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- async load function -->
<script>
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
  // only load tagcloud.js in tag.html
  if ($('#tag_cloud').length !== 0) {
    async ("/js/jquery.tagcloud.js", function () {
      $.fn.tagcloud.defaults = {
        //size: {start: 1, end: 1, unit: 'em'},
        color: {
          start: '#bbbbee',
          end: '#0085a1'
        },
      };
      $('#tag_cloud a').tagcloud();
    })
  }
</script>

<!--fastClick.js -->
<script>
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav) FastClick.attach($nav);
  })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->



    <a id="rocket" href="#top" class="iconfont icon-23435"></a>
    <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
    <!-- Image to hack wechat -->
    <!-- <img src="/img/icon_wechat.png" width="0" height="0" /> -->
    <!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
